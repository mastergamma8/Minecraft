<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC Bedrock Голосовой Чат (АнтиБлок)</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --mc-bg: #4d4d4d;
            --mc-panel: #c6c6c6;
            --mc-border-light: #ffffff;
            --mc-border-dark: #555555;
            --mc-text: #333333;
            --mc-button: #737373;
            --mc-button-active: #3e6b35;
        }

        body {
            background-color: var(--mc-bg);
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjNGRkNDRkIi8+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNGE0YTRhIi8+PHJlY3QgeD0iMzIiIHk9IjMyIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9IiM0YTRhNGEiLz48L3N2Zz4=');
            color: white;
            font-family: 'Press Start 2P', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--mc-panel);
            color: var(--mc-text);
            padding: 30px;
            border-top: 6px solid var(--mc-border-light);
            border-left: 6px solid var(--mc-border-light);
            border-bottom: 6px solid var(--mc-border-dark);
            border-right: 6px solid var(--mc-border-dark);
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 {
            font-size: 16px;
            text-shadow: 2px 2px 0px #888;
            margin-bottom: 20px;
            line-height: 1.5;
            color: #2b2b2b;
        }

        .panel {
            background-color: #8b8b8b;
            padding: 20px;
            margin-bottom: 20px;
            border-top: 4px solid var(--mc-border-dark);
            border-left: 4px solid var(--mc-border-dark);
            border-bottom: 4px solid var(--mc-border-light);
            border-right: 4px solid var(--mc-border-light);
        }

        input {
            width: 90%;
            padding: 15px;
            margin-bottom: 15px;
            background: #000;
            color: #fff;
            border: 4px solid #a0a0a0;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            outline: none;
            text-align: center;
        }

        input:focus {
            border-color: #fff;
        }

        button {
            background-color: var(--mc-button);
            color: white;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            padding: 15px 10px;
            border-top: 4px solid var(--mc-border-light);
            border-left: 4px solid var(--mc-border-light);
            border-bottom: 4px solid var(--mc-border-dark);
            border-right: 4px solid var(--mc-border-dark);
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0px #333;
            transition: all 0.1s;
        }

        button:active {
            border-top: 4px solid var(--mc-border-dark);
            border-left: 4px solid var(--mc-border-dark);
            border-bottom: 4px solid var(--mc-border-light);
            border-right: 4px solid var(--mc-border-light);
        }

        .btn-green { background-color: #3b8526; }
        .btn-red { background-color: #a83232; }
        .hidden { display: none; }

        #status {
            font-size: 9px;
            color: #ffaa00;
            margin-bottom: 15px;
            min-height: 25px;
            line-height: 1.4;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 4px;
        }

        .player-list {
            text-align: left;
            font-size: 10px;
            margin-top: 20px;
            background: rgba(0,0,0,0.1);
            padding: 10px;
        }

        .player-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .player-item::before {
            content: "• ";
            color: #3b8526;
            margin-right: 5px;
            font-size: 16px;
        }

        .network-badge {
            display: inline-block;
            font-size: 8px;
            padding: 3px 6px;
            background: #555;
            color: #fff;
            border-radius: 3px;
            margin-left: auto;
        }

        .net-ok { background: #3b8526; }
        .net-bad { background: #a83232; }

        #audio-container { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Voice Chat (АнтиБлок)</h1>
        <div id="status">Ожидание: выберите действие...<br><span style="color:#aaa;">(Режим обхода NAT активен)</span></div>

        <div id="setup-screen">
            <div class="panel">
                <button class="btn-green" onclick="createParty()">Создать сервер</button>
                <p style="font-size: 10px; margin: 15px 0;">-- ИЛИ --</p>
                <input type="text" id="host-id-input" placeholder="Введи ID друга">
                <button onclick="joinParty()">Подключиться</button>
            </div>
        </div>

        <div id="active-screen" class="hidden">
            <div class="panel">
                <p style="font-size: 10px; margin-bottom: 5px;">Твой ID для друзей:</p>
                <input type="text" id="my-id-display" readonly onclick="copyId()" style="cursor: pointer; color: #55ff55;">
                <p style="font-size: 8px; color: #444; margin-bottom: 15px;">(Нажми на код, чтобы скопировать)</p>
                
                <div class="player-list">
                    <div style="font-size: 10px; color: #444; margin-bottom: 10px;">Сеть:</div>
                    <div id="players-container">
                        <div class="player-item">Ты (Локал)</div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button id="mute-btn" onclick="toggleMute()">Выкл. микрофон</button>
                    <button class="btn-red" onclick="leaveParty()">Отключиться</button>
                </div>
            </div>
        </div>
    </div>

    <div id="audio-container"></div>

    <script>
        let peer = null;
        let myStream = null;
        let isHost = false;
        let activeCalls = {};
        let knownPeers = []; 
        let isMuted = false;

        const statusEl = document.getElementById('status');
        const setupScreen = document.getElementById('setup-screen');
        const activeScreen = document.getElementById('active-screen');
        const myIdDisplay = document.getElementById('my-id-display');
        const playersContainer = document.getElementById('players-container');
        const audioContainer = document.getElementById('audio-container');
        const muteBtn = document.getElementById('mute-btn');

        function setStatus(msg) {
            statusEl.innerHTML = msg;
        }

        async function getMicrophone() {
            try {
                // Оптимизация аудио для снижения нагрузки на сеть
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }, 
                    video: false 
                });
                myStream = stream;
                return true;
            } catch (err) {
                setStatus("<span style='color:red;'>Ошибка!</span> Дай разрешение на микрофон в настройках браузера!");
                console.error(err);
                return false;
            }
        }

        function initPeer() {
            const randomId = 'ru-' + Math.random().toString(36).substr(2, 5);
            
            // Расширенная конфигурация для обхода блокировок РФ
            peer = new Peer(randomId, {
                debug: 2,
                config: {
                    'iceServers': [
                        // Серверы Яндекса (отлично работают внутри РФ)
                        { urls: 'stun:stun.yandex.ru:3478' },
                        // Cloudflare (быстрые мировые серверы)
                        { urls: 'stun:stun.cloudflare.com:3478' },
                        // Стандартные Google серверы (на случай если Яндекс недоступен)
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        // Альтернативный открытый STUN
                        { urls: 'stun:stun.stunprotocol.org:3478' }
                    ]
                }
            });

            peer.on('open', (id) => {
                setStatus("<span style='color:#55ff55'>Подключено к сигнальной сети!</span>");
                myIdDisplay.value = id;
                setupScreen.classList.add('hidden');
                activeScreen.classList.remove('hidden');
            });

            peer.on('call', (call) => {
                call.answer(myStream);
                handleCall(call);
            });

            peer.on('connection', (conn) => {
                conn.on('data', (data) => {
                    if (isHost && data.type === 'REQUEST_PEERS') {
                        conn.send({ type: 'PEER_LIST', peers: knownPeers });
                        if (!knownPeers.includes(conn.peer)) {
                            knownPeers.push(conn.peer);
                        }
                    } else if (!isHost && data.type === 'PEER_LIST') {
                        data.peers.forEach(peerId => {
                            if (peerId !== peer.id && !activeCalls[peerId]) {
                                makeCall(peerId);
                            }
                        });
                    }
                });
            });

            peer.on('error', (err) => {
                let errorMsg = "Ошибка сети: " + err.type;
                if(err.type === 'peer-unavailable') {
                    errorMsg = "Друг с таким ID не найден!";
                } else if (err.type === 'network') {
                    errorMsg = "Блокировка сигнального сервера. Используйте VPN для подключения.";
                }
                setStatus("<span style='color:red'>" + errorMsg + "</span>");
                console.error(err);
            });
        }

        function handleCall(call) {
            call.on('stream', (remoteStream) => {
                addAudioStream(call.peer, remoteStream);
            });
            
            // Отслеживание состояния соединения для диагностики
            call.peerConnection.oniceconnectionstatechange = function() {
                updatePlayerState(call.peer, call.peerConnection.iceConnectionState);
            }

            activeCalls[call.peer] = call;
            updatePlayerList();
        }

        async function createParty() {
            setStatus("Настройка микрофона...");
            if (await getMicrophone()) {
                isHost = true;
                setStatus("Подключение к серверам Яндекса/Cloudflare...");
                initPeer();
            }
        }

        async function joinParty() {
            const hostId = document.getElementById('host-id-input').value.trim();
            if (!hostId) {
                setStatus("<span style='color:red'>Введи ID!</span>");
                return;
            }

            setStatus("Настройка микрофона...");
            if (await getMicrophone()) {
                isHost = false;
                setStatus("Поиск хоста...");
                initPeer();

                peer.on('open', () => {
                    makeCall(hostId);
                    const conn = peer.connect(hostId);
                    conn.on('open', () => conn.send({ type: 'REQUEST_PEERS' }));
                });
            }
        }

        function makeCall(peerId) {
            const call = peer.call(peerId, myStream);
            handleCall(call);
        }

        function addAudioStream(peerId, stream) {
            if (document.getElementById('audio-' + peerId)) return;
            const audioElement = document.createElement('audio');
            audioElement.id = 'audio-' + peerId;
            audioElement.srcObject = stream;
            audioElement.autoplay = true;
            audioElement.controls = false;
            audioContainer.appendChild(audioElement);
            updatePlayerList();
        }

        function updatePlayerState(peerId, state) {
            const badge = document.getElementById('state-' + peerId);
            if(badge) {
                if(state === 'connected' || state === 'completed') {
                    badge.innerText = 'Связь ОК';
                    badge.className = 'network-badge net-ok';
                } else if(state === 'disconnected' || state === 'failed') {
                    badge.innerText = 'Разрыв';
                    badge.className = 'network-badge net-bad';
                } else {
                    badge.innerText = 'Соединение...';
                    badge.className = 'network-badge';
                }
            }
        }

        function updatePlayerList() {
            playersContainer.innerHTML = '<div class="player-item">Ты <span class="network-badge net-ok">Локал</span></div>';
            Object.keys(activeCalls).forEach(id => {
                const el = document.createElement('div');
                el.className = 'player-item';
                // Берем только последние 5 символов ID для красоты
                const shortId = id.substring(id.length - 5);
                el.innerHTML = `Друг [${shortId}] <span id="state-${id}" class="network-badge">Ждем...</span>`;
                playersContainer.appendChild(el);
            });
        }

        function toggleMute() {
            if (!myStream) return;
            isMuted = !isMuted;
            myStream.getAudioTracks()[0].enabled = !isMuted;
            
            if (isMuted) {
                muteBtn.innerText = "Вкл. микрофон";
                muteBtn.classList.add('btn-red');
            } else {
                muteBtn.innerText = "Выкл. микрофон";
                muteBtn.classList.remove('btn-red');
            }
        }

        function copyId() {
            myIdDisplay.select();
            document.execCommand('copy');
            const oldText = statusEl.innerHTML;
            setStatus("<span style='color:#55ff55'>ID скопирован!</span> Отправь его друзьям.");
            setTimeout(() => setStatus(oldText), 2500);
        }

        function leaveParty() {
            if (peer) peer.destroy();
            if (myStream) myStream.getTracks().forEach(track => track.stop());
            window.location.reload();
        }
    </script>
</body>
</html>


